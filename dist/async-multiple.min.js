!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["async-multiple"]=t():e["async-multiple"]=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=s(r(6)),i=s(r(7)),u=r(3);function s(e){return e&&e.__esModule?e:{default:e}}function c(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var l=function(e){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));e._defaultParams={task:{type:[Array,Object],default:[]},rejectOnError:{type:Boolean,default:!1},handleStart:function(){},handleEnd:function(){},randomStep:{type:Boolean,default:!1},stepBettwen:{type:[Array,Number],default:0,min:0},stepTimeout:{type:Number,default:void 0,min:0},errorReplace:void 0,errorRetry:{type:Number,default:0,min:0},maxCall:{type:Number,default:1,min:0},maxSuccessCount:{type:Number,default:void 0},showProgress:{type:Boolean,default:!1},alias:{type:String,default:"TASK_"+e.randomString(8)},debug:{type:Boolean,default:!1}},e._formatType="each",e.taskStaus=u.UNCALL,e._stopAtNextTrick=!1,e._actionName=e.randomString(8);for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];return e._checkParams(n),e._initTask(),e._initHooks(),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),o(t,[{key:"start",value:function(){var e=this;return this.taskStaus=u.CALLING,this._beginTask().then(function(t){var r=(0,i.default)(t,["order"]),n={},o=r.map(function(t){return n["map"===e._formatType?t.input:t.order]=t.output,t.output});return Promise.resolve({response:t,allObject:n,allArray:r,outputArray:o,toObject:function(){return n},toArray:function(){return r}})})}},{key:"cancelTask",value:function(){this._debug("Calling the cancelTask method, task will stop at next trick!"),this._stopAtNextTrick=!0}},{key:"_assign",value:function(e){for(var t=this,r=arguments.length,n=Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return n=n.map(function(r){if(t.isType(r,{})){var n={};for(var o in r){var a=r[o];t.isType(a,{})?e.hasOwnProperty(o)||(n[o]=t.isType(a.default,function(){})?a.default():a.default):n[o]=a}return n}}),this.assign.apply(this,[e].concat(c(n)))}},{key:"_checkParams",value:function(e){var t=this;if(this._assign(this,this._defaultParams),this.isType(e[0],{}))this.assign(this,e[0]);else if(this.isType(e[0],[])&&(this.task=e[0],this.rejectOnError=e[1]||!1,e[2])){if(!this.isType(e[2],{}))throw this._errorManage("option expect to a object, please check!");this.assign(this,e[2])}var r=function(e){var r=t._defaultParams[e];if(t.isType(r,void 0))return"continue";if(t.isType(r,{})){if(!r.hasOwnProperty("type")||t.isType(t[e],void 0))return"continue";if(r.type=t.isType(r.type,[])?r.type:[r.type],0===r.type.filter(function(r){return r===t[e].constructor}).length){var n=r.type.map(function(e){return e.name});throw t._errorManage(e+" expect to a "+n+" but get a "+t.whatType(t[e])+", please check!")}}else if(!t.isType(r,t[e]))throw t._errorManage(e+" expect to a "+t.whatType(r)+" but get a "+t.whatType(t[e])+", please check!")};for(var n in this._defaultParams)r(n)}},{key:"_initTask",value:function(){var e=0,t=[];for(var r in this.task)t.push({order:e,stepKey:r,handle:this.task[r],status:u.UNCALL}),e++;if(0===t.length)throw this._errorManage("task is empty!");this.task=this.randomStep?this.shuffle(t):t}},{key:"_initHooks",value:function(){var e=this;if(this.showProgress){var t=this.handleEnd;this.handleEnd=function(){for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];t.apply(e,n),function(t){t.step;var r=t.all,n=t.progress,o=e.task.filter(function(e){return e.status===u.CALLED}).length;console.log("[ "+e.alias+" ] all: "+r+" complete: "+(o+1)+" progress: "+n)}.apply(e,n)}}}},{key:"_getStepBettwen",value:function(){return this.isType(this.stepBettwen,[])?this.randomNumber.apply(this,c(this.stepBettwen.slice(0,2))):this.stepBettwen}},{key:"_errorManage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"unexpected error!";return this.isType(e,"")||(e=e.toString()),new Error("[async-multiple ERROR]: "+e)}},{key:"_makeError",value:function(e){return e instanceof Error?e:e instanceof String?new Error(e):new Error(e.toString())}},{key:"_createQueue",value:function(){var e=this,t=this.task.filter(function(e){return e.status===u.UNCALL}),r=this.task.filter(function(e){return e.status===u.CALLING}),n=this.task.map(function(e){return e.order}),o=Math.min(this.maxCall-r.length,t.length);o<1||t.slice(0,o).map(function(t){var r=n.indexOf(t.order);e.task[r].status=u.CALLING,e.sleep(e._getStepBettwen()).then(function(){e._callTaskHandle(r)})})}},{key:"_beginTask",value:function(){var e=this,t=0,r=[];return this._createQueue(),new Promise(function(o,a){e.event.on(e._actionName,function(i){var s=i.error,c=i.output,l=i.step;if(e.taskStaus!==u.CALLED){if(e._stopAtNextTrick)return e.taskStaus=u.CALLED,void o(r);if(e.maxSuccessCount&&r.filter(function(e){return!e.error}).length>=e.maxSuccessCount)return e._debug("Enough success result, task will stop!"),e.taskStaus=u.CALLED,void o(r);if(s){if(e.errorRetry>t)return t+=1,e.task[l].status=u.UNCALL,void e._createQueue();if(s=e._makeError(s),e.rejectOnError)return a(s)}t=0,e.task[l].status=u.CALLED,r.push(e.removeUndefined(n({},e.task[l],{output:c,error:s,handle:void 0,status:void 0,stepKey:void 0}))),e.task.filter(function(e){return e.status===u.CALLED}).length!==e.task.length?e._createQueue():(e.taskStaus=u.CALLED,o(r))}})})}},{key:"_debug",value:function(){if(this.debug){for(var e,r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];(e=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in o)return o.value;var i=o.get;return void 0!==i?i.call(n):void 0}(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_debug",this)).call.apply(e,[this].concat(n))}}},{key:"_callTaskHandle",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t>this.task.length-1||t<0)return Promise.reject(this._errorManage("step overflow!"));var o=u.PENDING,a=null,i=this.task.length,s=this.task.filter(function(e){return e.status===u.CALLED}).length,c=function(e){return(100*e/i).toFixed(2)+"%"};this.handleStart&&this.handleStart(n({step:t,all:i,progress:c(s)},this.task[t],{isRetry:r,cancelTask:this.cancelTask.bind(this)}));var l=function(l){if(e.taskStaus!==u.CALLED&&o===u.PENDING){o=u.REJECT,a&&clearInterval(a);var f=n({},e.task[t],{all:i,progress:c(s+1),output:e._getTaskOutput,error:l,step:t,isRetry:r});e.handleEnd&&e.handleEnd(f),e.event.emit(e._actionName,f)}};this.isType(this.stepTimeout,void 0)||(a=setTimeout(function(){l(e._makeError("timeout!"))},this.stepTimeout)),this.makePromise(this.task[t].handle(this.task[t].input,t,this.cancelTask.bind(this),this.task[t].stepKey)).then(function(l){if(e.taskStaus!==u.CALLED&&o===u.PENDING){o=u.RESOLVE,a&&clearInterval(a);var f=n({},e.task[t],{all:i,progress:c(s+1),output:l,error:null,step:t,isRetry:r,cancelTask:e.cancelTask.bind(e)});e.handleEnd&&e.handleEnd(f),e.event.emit(e._actionName,f)}},l)}},{key:"_getTaskOutput",get:function(){return this.isType(this.errorReplace,void 0)?null:this.errorReplace}}]),t}();t.default=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,[{key:"whatType",value:function(e){return Object.prototype.toString.call(e)}},{key:"shuffle",value:function(e){return e.map(function(e){return{v:e,r:Math.random()}}).sort(function(e,t){return e.r-t.r}).map(function(e){return e.v})}},{key:"assign",value:function(){return Object.assign.apply(Object,arguments)}},{key:"isType",value:function(){for(var e=this,t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return 0===r.map(function(t){return e.whatType(t)===e.whatType(r[0])}).filter(function(e){return!e}).length}},{key:"isPromise",value:function(e){return!(!e.then||!this.isType(e,e.then,function(){}))}},{key:"makePromise",value:function(e){return this.isPromise(e)?e:Promise.resolve(e)}},{key:"arrayToObject",value:function(e){if(!this.isType(e,[]))throw new Error("[arrayToObject error]: expect a array!");var t={};return e.map(function(e,r){t[r]=e}),t}},{key:"sleep",value:function(e){return new Promise(function(t,r){setTimeout(function(){return t("[Sleep]: "+e+"ms")},e)})}},{key:"removeUndefined",value:function(e){if(!this.isType(e,{}))throw new Error("[removeUndefined message]: obj expect a "+this.whatType({}));for(var t in e)this.isType(e[t],void 0)&&delete e[t];return e}},{key:"randomString",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8,t="",r=function(){var e=Math.floor(62*Math.random());return e<10?e:e<36?String.fromCharCode(e+55):String.fromCharCode(e+61)};t.length<e;)t+=r();return t}},{key:"randomNumber",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!this.isType(e,t,1))throw new Error("[randomNumber message]: obj expect a "+this.whatType(1));if(e>t)throw new Error("[randomNumber message]: start number big than end!");var n=Math.random()*(t-e)+e;return r?parseInt(n):n}}]),e}();t.default=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(e){return e&&e.__esModule?e:{default:e}}(r(1));var a=function(e){function t(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).debug,r=void 0!==e&&e;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._callbacks={},n._isDebug=r,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default),n(t,[{key:"on",value:function(e,t,r){this.isType(e,"")||this._errorManage("name expected a string!"),this.isType(t,function(){})||this._errorManage("callback expected a function!"),!this.isType(r,void 0)&&!this.isType(r,1)&&r<=0&&this._errorManage("times expected a number(min 1)!"),this._debug("Add listener for "+e),this._callbacks[e]=this._callbacks[e]||[],this._callbacks[e].push({fn:t,times:r})}},{key:"emit",value:function(e){for(var t=this,r=arguments.length,n=Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];this.isType(e,"")||this._errorManage("name expected a string!"),this._callbacks[e]&&this._callbacks[e].map(function(r,o){if(t.isType(r,{})){var a=r.fn,i=r.times;if(a.apply(void 0,n),!t.isType(i,void 0)){var u=i>1?{fn:a,times:i-1}:void 0;t._callbacks[e].splice(o,1,u)}}})}},{key:"remove",value:function(e){this.isType(e,"")||this._errorManage("name expected a string!"),this._callbacks[e]||this._errorManage("action named "+e+" wasn't bind or removed!"),delete this._callbacks[e]}},{key:"once",value:function(e){return this.on(e,arguments.length<=1?void 0:arguments[1],1)}},{key:"_debug",value:function(e){this._isDebug&&e&&(this.isType(e,"")||(e=e.toString()),console.log("[event MESSAGE]: "+e))}},{key:"_errorManage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"unexpected error!";throw this.isType(e,"")||(e=e.toString()),new Error("[event ERROR]: "+e)}}]),t}();t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.PENDING="PENDING",t.RESOLVE="RESOLVE",t.REJECT="REJECT",t.UNCALL="UNCALL",t.CALLING="CALLING",t.CALLED="CALLED"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Event=t.Each=t.Map=t.each=t.map=void 0;var n=i(r(5)),o=i(r(0)),a=i(r(2));function i(e){return e&&e.__esModule?e:{default:e}}t.map=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(new(Function.prototype.bind.apply(n.default,[null].concat(t)))).start()},t.each=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(new(Function.prototype.bind.apply(o.default,[null].concat(t)))).start()};t.Map=n.default,t.Each=o.default,t.Event=a.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(e){return e&&e.__esModule?e:{default:e}}(r(0)),a=r(3);var i=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._formatType="map",r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default),n(t,[{key:"_initTask",value:function(){var e=this,t=0,r=[];for(var n in this.task)r.push({order:t,input:this.task[n],stepKey:n,handle:function(){return e.handle.apply(e,arguments)},status:a.UNCALL}),t++;if(0===r.length)throw this._errorManage("task is empty!");this.task=this.randomStep?this.shuffle(r):r}}]),t}();t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=i(r(1)),a=i(r(2));function i(e){return e&&e.__esModule?e:{default:e}}var u=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.event=new a.default,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default),n(t,[{key:"_errorManage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"unexpected error!";return this.isType(e,"")||(e=e.toString()),new Error("[async-multiple ERROR]: "+e)}},{key:"_debug",value:function(e){e&&(this.isType(e,"")||(e=e.toString()),console.log("[async-multiple MESSAGE]: "+e))}}]),t}();t.default=u},function(e,t){var r,n;e.exports=function(e,t){return e.sort(function(e,n){var o,a,i,u,s,c;for(a=0,i=t.length;a<i;a++)if("object"==typeof(o=t[a])?(u=o.predicate,s=o.reverse):u=o,0!==(c=r(u,s)(e,n)))return c})},n={get:function(e,t){var r,n,o,a;for(a=e,r=0,o=(n=t.split(".")).length;r<o;r++)a=a[n[r]];return a},set:function(e,t,r){var n,o,a,i,u,s,c;for(n=(i=t.split(".")).slice(0,-1),u=i[i.length-1],c=e,o=0,s=n.length;o<s;o++)c=null!=c[a=n[o]]?c[a]:c[a]={};return c[u]=r}},r=function(e,t){var r;return r="function"==typeof e?function(t){return e(t)}:function(t){return n.get(t,e)},t?function(e,t){return r(e)>r(t)?-1:r(e)<r(t)?1:0}:function(e,t){return r(e)<r(t)?-1:r(e)>r(t)?1:0}}}])});